# These "stages" are actually separately initiated VMs, so better used for different configurations, etc
stages:
  - docs
  - lint
  - assemble
  - test
  - coverage
  - deploy_internally
  - deploy_beta

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_REF_PROTECTED == "true"
      when: always

tasks:
  stage: docs
  tags:
    - m1-baremetal
  script:
    - ./gradlew tasks

taskTree:
  stage: docs
  variables:
    ANDROID_HOME: "/opt/homebrew/share/android-commandlinetools"
  tags:
    - m1-baremetal
  script:
    - ./gradlew build taskTree # Print taskTree for ./gradlew build

kDoctor:
  stage: docs
  tags:
    - m1-baremetal
  script:
    - brew install kdoctor
    - kdoctor

lintVitalRelease:
  stage: lint
  tags:
    - m1-baremetal
  variables:
    ANDROID_HOME: "/opt/homebrew/share/android-commandlinetools"
  script:
    - ./gradlew :src:lintVitalRelease

lint:
  stage: lint
  tags:
    - m1-baremetal
  variables:
    ANDROID_HOME: "/opt/homebrew/share/android-commandlinetools"
  script:
    - ./gradlew lint -x :src:lintDebug # Skips android linter with 356 errors, 500 warnings.

assemble:
  stage: assemble
  tags:
    - m1-baremetal
  variables:
    ANDROID_HOME: "/opt/homebrew/share/android-commandlinetools"
  script:
    - ./gradlew assemble
    - ./gradlew :src:allMetadataJar
    - ./gradlew :src:assembleDebug
    - ./gradlew :src:assembleRelease

compileIos:
  stage: assemble
  tags:
    - m1-baremetal
  script:
    - ./gradlew :src:compileKotlinIosArm64
    - ./gradlew :src:compileKotlinIosSimulatorArm64
    - ./gradlew :src:compileKotlinIosX64
    - ./gradlew :src:iosArm64MetadataJar
    - ./gradlew :src:iosSimulatorArm64MetadataJar
    - ./gradlew :src:iosX64MetadataJar

compileMac:
  stage: assemble
  tags:
    - m1-baremetal
  script:
    - ./gradlew :src:compileKotlinMacosArm64
    - ./gradlew :src:compileKotlinMacosX64

jvmJar:
  stage: assemble
  tags:
    - m1-baremetal
  script:
    - ./gradlew :src:jvmJar

linkFrameworkIos:
  stage: assemble
  tags:
    - m1-baremetal
  script:
    - ./gradlew :src:linkDebugFrameworkIosArm64
    - ./gradlew :src:linkDebugFrameworkIosFat
    - ./gradlew :src:linkDebugFrameworkIosSimulatorArm64
    - ./gradlew :src:linkDebugFrameworkIosX64
    - ./gradlew :src:linkReleaseFrameworkIosArm64
    - ./gradlew :src:linkReleaseFrameworkIosFat
    - ./gradlew :src:linkReleaseFrameworkIosSimulatorArm64
    - ./gradlew :src:linkReleaseFrameworkIosX64

macMetadataJar:
  stage: assemble
  tags:
    - m1-baremetal
  script:
    - ./gradlew :src:macosArm64MetadataJar
    - ./gradlew :src:macosX64MetadataJar

iosArm64Test:
  stage: test
  tags:
    - m1-baremetal
  resource_group: iphone_mac_emulators
  script:
    - ./gradlew :src:cleanIosSimulatorArm64Test :src:iosSimulatorArm64Test

iosX64Test:
  stage: test
  tags:
    - m1-baremetal
  script:
    - ./gradlew :src:iosX64Test

iosEmulatorUiTest:
  stage: test
  resource_group: iphone_mac_emulator
  tags:
    - m1-baremetal
  script:
    - cd iosApp
    - gem install bundler
    - gem install fastlane
    - bundle install
    - bundle update
    - bundle exec fastlane ios test_emulator
  artifacts:
    when: always
    reports:
      junit: iosApp/fastlane/report.xml
    paths:
      - iosApp/fastlane/report.xml
      - iosApp/fastlane/test_output/report.html
      - iosApp/fastlane/test_output/report.junit

iosDeviceUiTest:
  stage: test
  resource_group: iphone_mac_emulator
  tags:
    - m1-baremetal
  script:
    - cd iosApp
    - gem install xcpretty
    - ./rundevicetests.sh $DEVICE_UDID
  artifacts:
    reports:
      junit: iosApp/iphone-ui-test-report.xml
    expire_in: 4 week

jvmTest: #
  stage: test
  tags:
    - m1-baremetal
  script:
    - ./gradlew :src:cleanJvmTest :src:jvmTest
  artifacts:
    reports:
      junit: src/build/test-results/jvmTest/TEST-*.xml

macArm64Test:
  stage: test
  tags:
    - m1-baremetal
  resource_group: iphone_mac_emulators
  script:
    - ./gradlew :src:cleanMacosArm64Test :src:macosArm64Test

macX64Test:
  stage: test
  tags:
    - m1-baremetal
  script:
    - ./gradlew :src:cleanIosSimulatorArm64Test :src:iosSimulatorArm64Test

# I'm assuming that this only runs Android tests
androidTest:
  image: inovex/gitlab-ci-android
  stage: test
  before_script:
    - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
  script:
    - ./gradlew src:test
  artifacts:
    reports:
      junit: src/build/test-results/testDebugUnitTest/TEST-*.xml

testCoverageReport:
  image: inovex/gitlab-ci-android
  stage: coverage
  script:
    - ./gradlew koverXmlReport koverHtmlReport
  artifacts:
    expire_in: 4 week
    paths:
      - src/build/reports/kover/report.xml
      - src/build/reports/kover/html

pages:
  stage: coverage
  needs:
    - testCoverageReport
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == "true"
  script:
    - mkdir public
    - cp -r src/build/reports/kover/html/* public/
  artifacts:
    expire_in: 4 week
    paths:
      - public


# Code coverage reporter for common, JVM and android
codeCoveragePercent:
  image: inovex/gitlab-ci-android
  stage: coverage
  script:
    - ./gradlew koverLog
  coverage: '/application line coverage: ([0-9]+(?:\.[0-9]+)?)%/' # Reports coverage to GitLab

testflight:
  rules:
        - if: $CI_COMMIT_REF_PROTECTED == "true"
  stage: deploy_internally
  tags:
    - m1-baremetal
  script:
    - mkdir iosApp/fastlane/keys
    # setting up ".env" file
    - echo "APP_STORE_CONNECT_API_KEY_PATH=$APP_STORE_CONNECT_API_KEY_PATH" >> iosApp/.env
    - echo "APPLE_ID=$APPLE_ID" >> iosApp/.env
    - echo "ITC_TEAM_ID=$ITC_TEAM_ID" >> iosApp/.env
    - echo "TEAM_ID=$TEAM_ID" >> iosApp/.env
    # setting up fastlane keys: json
    # see this for the correct quoting
    # https://docs.gitlab.com/ee/ci/yaml/script.html#use-special-characters-with-script
    - echo $KEYSJSON | base64 --decode > iosApp/fastlane/keys/$key_id.json
    # setting up fastlane keys: p8
    - echo $KEYSP8 | base64 --decode > iosApp/fastlane/keys/$key_id.p8
    # Run fastlane
    - cd iosApp/
    - gem install bundler
    - gem install fastlane
    - bundle install
    - bundle update
    - bundle exec fastlane ios beta --verbose

testflight_public:
  environment:
    name: "beta deploy"
  allow_failure: false
  only:
    - master
    - mp
  when: manual
  stage: deploy_beta
  tags:
    - m1-baremetal
  script:
    - mkdir iosApp/fastlane/keys
    # setting up ".env" file
    - echo "APP_STORE_CONNECT_API_KEY_PATH=$APP_STORE_CONNECT_API_KEY_PATH" >> iosApp/.env
    - echo "APPLE_ID=$APPLE_ID" >> iosApp/.env
    - echo "ITC_TEAM_ID=$ITC_TEAM_ID" >> iosApp/.env
    - echo "TEAM_ID=$TEAM_ID" >> iosApp/.env
    # setting up fastlane keys: json
    # see this for the correct quoting
    # https://docs.gitlab.com/ee/ci/yaml/script.html#use-special-characters-with-script
    - echo $KEYSJSON | base64 --decode > iosApp/fastlane/keys/$key_id.json
    # setting up fastlane keys: p8
    - echo $KEYSP8 | base64 --decode > iosApp/fastlane/keys/$key_id.p8
    # Run fastlane
    - cd iosApp/
    - gem install bundler
    - gem install fastlane
    - bundle install
    - bundle update
    - bundle exec fastlane ios beta_public --verbose
